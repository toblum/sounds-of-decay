var b=Object.defineProperty;var C=(e,t,s)=>t in e?b(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var c=(e,t,s)=>(C(e,typeof t!="symbol"?t+"":t,s),s);const _=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function s(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerpolicy&&(a.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?a.credentials="include":o.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=s(o);fetch(o.href,a)}};_();let u=[];const x=e=>{e.state="paused",e.setup=function(){e.createCanvas(800,300),e.windowResized()},e.windowResized=function(){const o=document.getElementById("p5-container").clientWidth,a=document.getElementById("p5-container").clientHeight;e.resizeCanvas(o,a)},e.draw=function(){e.background(54,165,183),e.state==="paused"?(e.bb=new t(90),e.bb.display()):(e.pb=new s(40,25,25),e.pb.display());for(let o=u.length-1;o>=0;o--)u[o].isDead()?u.splice(o,1):(u[o].grow(),u[o].display())},e.mousePressed=()=>{if(e.state==="playing"){const o=new i(e.mouseX,e.mouseY);u.push(o);const a=new Event("clickCanvas");e._userNode.dispatchEvent(a)}if(e.state==="paused"&&e.bb&&e.bb.isHovered()){const o=new Event("clickPlay");e._userNode.dispatchEvent(o),e.state="playing"}if(e.state!=="paused"&&e.pb&&e.pb.isHovered()){const o=new Event("clickPause");e._userNode.dispatchEvent(o),e.state="paused"}},e.addDecayParticle=()=>{const o=new i(e.random(e.width),e.random(e.height));u.push(o)},e.pause=()=>{e.state="paused"};class t{constructor(a){this.size=a,this.xpos=e.width/2,this.ypos=e.height/2}isHovered(){const a=this.size/2;return e.mouseX>this.xpos-a&&e.mouseX<this.xpos+a&&e.mouseY>this.ypos-a&&e.mouseY<this.ypos+a}display(){const a=this.isHovered(),n=a?200:80;let r=e.color(255,255,255,n);e.fill(r);let l=e.color(255,255,255);e.stroke(l),e.rectMode(e.CENTER),e.rect(this.xpos,this.ypos,this.size,this.size,20);const d=a?150:50;r=e.color(0,0,0,d),e.fill(r),e.triangle(this.xpos-this.size*.3,this.ypos-this.size*.3,this.xpos-this.size*.3,this.ypos+this.size*.3,this.xpos+this.size*.3,this.ypos)}}class s{constructor(a,n,r){this.size=a,this.xpos=n,this.ypos=r}isHovered(){const a=this.size/2;return e.mouseX>this.xpos-a&&e.mouseX<this.xpos+a&&e.mouseY>this.ypos-a&&e.mouseY<this.ypos+a}display(){const a=this.isHovered(),n=a?200:80;let r=e.color(255,255,255,n);e.fill(r);let l=e.color(255,255,255);e.stroke(l),e.rectMode(e.CENTER),e.rect(this.xpos,this.ypos,this.size,this.size,5);const d=a?150:50;r=e.color(0,0,0,d),e.fill(r),e.stroke(r),e.rect(this.xpos-this.size*.2,this.ypos+this.size*0,this.size*.25,this.size*.5),e.rect(this.xpos+this.size*.2,this.ypos+this.size*0,this.size*.25,this.size*.5)}}class i{constructor(a,n){this.x=a,this.y=n,this.diameter=1,this.lifespan=255}grow(){this.diameter=this.diameter+4,this.lifespan=this.lifespan-5}isDead(){return this.lifespan<=0}display(){e.fill(255,this.lifespan/1.5),e.stroke(255,this.lifespan/.1),e.ellipse(this.x,this.y,this.diameter,this.diameter)}}};class P{constructor(){c(this,"SAMPLE_LIBRARY",{"Grand Piano":[{note:"A",octave:4,file:"samples/Grand Piano/piano-f-a4.wav"},{note:"A",octave:5,file:"samples/Grand Piano/piano-f-a5.wav"},{note:"A",octave:6,file:"samples/Grand Piano/piano-f-a6.wav"},{note:"C",octave:4,file:"samples/Grand Piano/piano-f-c4.wav"},{note:"C",octave:5,file:"samples/Grand Piano/piano-f-c5.wav"},{note:"C",octave:6,file:"samples/Grand Piano/piano-f-c6.wav"},{note:"D#",octave:4,file:"samples/Grand Piano/piano-f-d#4.wav"},{note:"D#",octave:5,file:"samples/Grand Piano/piano-f-d#5.wav"},{note:"D#",octave:6,file:"samples/Grand Piano/piano-f-d#6.wav"},{note:"F#",octave:4,file:"samples/Grand Piano/piano-f-f#4.wav"},{note:"F#",octave:5,file:"samples/Grand Piano/piano-f-f#5.wav"},{note:"F#",octave:6,file:"samples/Grand Piano/piano-f-f#6.wav"}],"Chorus female":[{note:"A",octave:4,file:"samples/Chorus/chorus-female-a4-PB-loop.wav"},{note:"A#",octave:4,file:"samples/Chorus/chorus-female-a#4-PB-loop.wav"},{note:"A",octave:5,file:"samples/Chorus/chorus-female-a5-PB-loop.wav"},{note:"A#",octave:5,file:"samples/Chorus/chorus-female-a#5-PB-loop.wav"},{note:"B",octave:4,file:"samples/Chorus/chorus-female-b4-PB-loop.wav"},{note:"B",octave:5,file:"samples/Chorus/chorus-female-b5-PB-loop.wav"},{note:"C",octave:5,file:"samples/Chorus/chorus-female-c5-PB-loop.wav"},{note:"C#",octave:5,file:"samples/Chorus/chorus-female-c#5-PB-loop.wav"},{note:"C",octave:6,file:"samples/Chorus/chorus-female-c6-PB-loop.wav"},{note:"D",octave:5,file:"samples/Chorus/chorus-female-d5-PB-loop.wav"},{note:"D#",octave:5,file:"samples/Chorus/chorus-female-d#5-PB-loop.wav"},{note:"E",octave:5,file:"samples/Chorus/chorus-female-e5-PB-loop.wav"},{note:"F",octave:5,file:"samples/Chorus/chorus-female-f5-PB-loop.wav"},{note:"F#",octave:5,file:"samples/Chorus/chorus-female-f#5-PB-loop.wav"},{note:"G",octave:4,file:"samples/Chorus/chorus-female-g4-PB-loop.wav"},{note:"G",octave:5,file:"samples/Chorus/chorus-female-g5-PB-loop.wav"},{note:"G#",octave:4,file:"samples/Chorus/chorus-female-g#4-PB-loop.wav"},{note:"G#",octave:5,file:"samples/Chorus/chorus-female-g#5-PB-loop.wav"}],Tremulo:[{note:"A#",octave:3,file:"samples/Tremulo/3_Bb.wav"},{note:"G",octave:3,file:"samples/Tremulo/3_G.wav"},{note:"A#",octave:4,file:"samples/Tremulo/4_Bb.wav"},{note:"C#",octave:4,file:"samples/Tremulo/4_Db.wav"},{note:"G",octave:4,file:"samples/Tremulo/4_G.wav"},{note:"B",octave:5,file:"samples/Tremulo/5_B.wav"},{note:"C#",octave:5,file:"samples/Tremulo/5_Db.wav"},{note:"E",octave:5,file:"samples/Tremulo/5_E.wav"},{note:"G",octave:5,file:"samples/Tremulo/5_G.wav"}]});c(this,"CONVOLVER_LIBRARY",{AirportTerminal:"samples/AirportTerminal.wav",RoomMedium:"samples/RoomMedium.wav"});c(this,"OCTAVE",["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]);c(this,"_audioContext",null);c(this,"_sampleCache",{});c(this,"_convolverCache",{});c(this,"_instrument","Grand Piano");c(this,"_convolver",null);c(this,"_gain",.7);c(this,"_fade",.7);this._audioContext=new AudioContext}fetchSample(t){return fetch(encodeURI(t)).then(s=>s.arrayBuffer()).then(s=>this._audioContext.decodeAudioData(s))}noteValue(t,s){return s*12+this.OCTAVE.indexOf(t)}getNoteDistance(t,s,i,o){return this.noteValue(t,s)-this.noteValue(i,o)}getNearestSample(t,s,i){return t.slice().sort((a,n)=>{let r=Math.abs(this.getNoteDistance(s,i,a.note,a.octave)),l=Math.abs(this.getNoteDistance(s,i,n.note,n.octave));return r-l})[0]}flatToSharp(t){switch(t){case"Bb":return"A#";case"Db":return"C#";case"Eb":return"D#";case"Gb":return"F#";case"Ab":return"G#";default:return t}}async getSample(t,s){let[,i,o]=/^(\w[b#]?)(\d)$/.exec(s);o=parseInt(o,10),i=this.flatToSharp(i);let a=this.SAMPLE_LIBRARY[t],n=this.getNearestSample(a,i,o),r=this.getNoteDistance(i,o,n.note,n.octave);if(this._sampleCache[n.file])return{audioBuffer:this._sampleCache[n.file],distance:r};{const l=await this.fetchSample(n.file);return this._sampleCache[n.file]=l,{audioBuffer:l,distance:r}}}async playSample(t,s=0){await this.playSampleWithInstrument(this._instrument,t,this._convolver,s)}async playSampleWithInstrument(t,s,i=null,o=0){const{audioBuffer:a,distance:n}=await this.getSample(t,s);let r=Math.pow(2,n/12),l=this._audioContext.createBufferSource();l.buffer=a,l.playbackRate.value=r;const d=this._audioContext.createGain();d.gain.value=this._gain,d.gain.linearRampToValueAtTime(0,this._audioContext.currentTime+this._fade),i?l.connect(d).connect(i):l.connect(d).connect(this._audioContext.destination);const w=o>0?this._audioContext.currentTime+o:null;l.start(w)}async loadConvolver(t){const s=await this.fetchSample(t);let i=this._audioContext.createConvolver();return i.buffer=s,i.connect(this._audioContext.destination),console.log("Convolver loaded"),i}async setConvolver(t){const s=this.CONVOLVER_LIBRARY[t];if(s){if(!this._convolverCache[s]){const i=await this.loadConvolver(s);this._convolverCache[s]=i}console.log("setConvolver()",t,s),this._convolver=this._convolverCache[s]}else console.log("Deactivated convolver",t),this._convolver=null}setInstrument(t){this.SAMPLE_LIBRARY[t]?this._instrument=t:console.warn("Selected instrument not found:",t)}setGain(t){this._gain=t}setFade(t){this._fade=Number(Number(t).toFixed(2))}suspend(){this._audioContext.suspend()}resume(){this._audioContext.resume()}}const f={musicforairports:{title:"Brian Eno - Ambient 1: Music for Airports, 2/1 (1978)",notes:["F4","Ab4","C5","Db5","Eb5","F5","Ab5"]},gesdur_pentatonic:{title:"Ges-Dur-Pentatonik (schwarze Tasten)",notes:["F#2","G#2","A#2","C#3","D#3"]},cdur_pentatonic:{title:"C-Dur-Pentatonik",notes:["C3","D3","E3","G3","A3"]},amoll_pentatonic:{title:"A-Moll-Pentatonik",notes:["A2","C3","D3","E3","G3"]}},g={random:{title:"Random note from the pool"},static_melody:{title:"Static melody"},changing_melody_10:{title:"Changing melody, 10% chance"},changing_melody_30:{title:"Changing melody, 30% chance"},changing_melody_60:{title:"Changing melody, 60% chance"}};class B{constructor(t){this.soundGenerator=t,this.setNotepool("musicforairports"),this.setMelodygenerator("random"),this.currentNoteIndex=0}setNotepool(t){return f[t]?(this.currentNotepool=f[t].notes,this.currentMelody=[...f[t].notes],!0):!1}setMelodygenerator(t){return g[t]?(this.currentMelodygenerator=t,!0):!1}increaseNoteIndex(){this.currentNoteIndex++,this.currentNoteIndex>=this.currentMelody.length&&(this.currentNoteIndex=0)}playNextNote(){var t;if(this.currentMelodygenerator==="random")t=this.currentMelody[Math.floor(Math.random()*this.currentMelody.length)];else{t=this.currentMelody[this.currentNoteIndex];let i=!1;if(this.currentMelodygenerator==="changing_melody_10"&&Math.random()<.1&&(i=!0),this.currentMelodygenerator==="changing_melody_30"&&Math.random()<.3&&(i=!0),this.currentMelodygenerator==="changing_melody_60"&&Math.random()<.3&&(i=!0),i){var s=this.currentNotepool[Math.floor(Math.random()*this.currentNotepool.length)];this.currentMelody[this.currentNoteIndex]=s,console.log("Melody change:",s,this.currentMelody)}this.increaseNoteIndex()}t&&this.soundGenerator.playSample(t)}}document.querySelector("#app").innerHTML=`
<div>
	<div id="header">
		<div>
			Sounds of decay
		</div>
		<div>
			Note pool:<br/>
			<select id="sel_notepool">
			</select>
		</div>
		<div>
			Melody generator:<br/>
			<select id="sel_melodygenerator">
			</select>
		</div>
		<div>
			Intrument:<br/>
			<select id="sel_instrument">
				<option value="Grand Piano">Grand Piano</option>
				<option value="Chorus female">Chorus female</option>
				<option value="Tremulo">Tremulo</option>
			</select>
		</div>
		<div>
			Effects/convolver:<br/>
			<select id="sel_convolver">
				<option value="">- None -</option>
				<option value="RoomMedium">Medium room</option>
				<option value="AirportTerminal">Airport Terminal</option>
			</select>
		</div>
		<div>
			Gain:<br/>
			<input type="range" id="rng_gain" min="0" max="2" value="0.7" step="0.01">
		</div>
		<div>
			Fade time:<br/>
			<input type="range" id="rng_fade" min="0" max="2" value="0.7" step="0.1">
		</div>
	</div>

	<div id="p5-container"></div>

	<div id="footer">
		<div>More informations: <a href="https://github.com/toblum/sounds-of-decay" target="_blank">https://github.com/toblum/sounds-of-decay</a></div>
	</div>
</div>`;const m=document.getElementById("p5-container"),y=new p5(x,m),h=new P,p=new B(h);let v=new WebSocket("wss://decayrelay.tobiasblum.de");v.onopen=function(){console.log("[open] Connection established"),console.log("Sending to server")};v.onclose=function(e){e.wasClean?console.log(`[close] Connection closed cleanly, code=${e.code} reason=${e.reason}`):console.log("[close] Connection died")};v.onerror=function(e){console.log(`[error] ${e.message}`)};(async()=>{let e=!1;const t=()=>{p.playNextNote()},s=()=>{e=!0};v.onmessage=function(n){console.log(`[message] Data received from server: ${n.data}`),e&&t(),y.addDecayParticle()};const i=()=>{e=!1,y.pause()};for(const n in f){const r=f[n];var o=document.createElement("option");o.text=r.title,o.value=n,document.getElementById("sel_notepool").add(o)}document.getElementById("sel_notepool").addEventListener("change",n=>{console.log("Set notepool to:",n.target.value),p.setNotepool(n.target.value)});for(const n in g){const r=g[n];var a=document.createElement("option");a.text=r.title,a.value=n,document.getElementById("sel_melodygenerator").add(a)}document.getElementById("sel_melodygenerator").addEventListener("change",n=>{console.log("Set melody generator to:",n.target.value),p.setMelodygenerator(n.target.value)}),document.getElementById("sel_instrument").addEventListener("change",n=>{console.log("Set intrument to:",n.target.value),h.setInstrument(n.target.value)}),document.getElementById("sel_convolver").addEventListener("change",n=>{console.log("Set convolver to:",n.target.value),h.setConvolver(n.target.value)}),document.getElementById("rng_gain").addEventListener("input",n=>{console.log("Set gain to:",n.target.value),h.setGain(n.target.value)}),document.getElementById("rng_fade").addEventListener("input",n=>{console.log("Set fade to:",n.target.value),h.setFade(n.target.value)}),m.addEventListener("clickPlay",()=>{s()}),m.addEventListener("clickPause",()=>{i()}),m.addEventListener("clickCanvas",()=>{t()})})();
