var w=Object.defineProperty;var b=(e,t,n)=>t in e?w(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var c=(e,t,n)=>(b(e,typeof t!="symbol"?t+"":t,n),n);const C=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerpolicy&&(s.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?s.credentials="include":o.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}};C();let u=[];const x=e=>{e.state="paused",e.setup=function(){e.createCanvas(800,300),e.windowResized()},e.windowResized=function(){const o=document.getElementById("p5-container").clientWidth,s=document.getElementById("p5-container").clientHeight;e.resizeCanvas(o,s)},e.draw=function(){e.background(54,165,183),e.state==="paused"?(e.bb=new t(90),e.bb.display()):(e.pb=new n(40,25,25),e.pb.display());for(let o=u.length-1;o>=0;o--)u[o].isDead()?u.splice(o,1):(u[o].grow(),u[o].display())},e.mousePressed=()=>{if(e.state==="playing"){const o=new i(e.mouseX,e.mouseY);u.push(o);const s=new Event("clickCanvas");e._userNode.dispatchEvent(s)}if(e.state==="paused"&&e.bb&&e.bb.isHovered()){const o=new Event("clickPlay");e._userNode.dispatchEvent(o),e.state="playing"}if(e.state!=="paused"&&e.pb&&e.pb.isHovered()){const o=new Event("clickPause");e._userNode.dispatchEvent(o),e.state="paused"}},e.addDecayParticle=()=>{const o=new i(e.random(e.width),e.random(e.height));u.push(o)},e.pause=()=>{e.state="paused"};class t{constructor(s){this.size=s,this.xpos=e.width/2,this.ypos=e.height/2}isHovered(){const s=this.size/2;return e.mouseX>this.xpos-s&&e.mouseX<this.xpos+s&&e.mouseY>this.ypos-s&&e.mouseY<this.ypos+s}display(){const s=this.isHovered(),a=s?200:80;let r=e.color(255,255,255,a);e.fill(r);let l=e.color(255,255,255);e.stroke(l),e.rectMode(e.CENTER),e.rect(this.xpos,this.ypos,this.size,this.size,20);const d=s?150:50;r=e.color(0,0,0,d),e.fill(r),e.triangle(this.xpos-this.size*.3,this.ypos-this.size*.3,this.xpos-this.size*.3,this.ypos+this.size*.3,this.xpos+this.size*.3,this.ypos)}}class n{constructor(s,a,r){this.size=s,this.xpos=a,this.ypos=r}isHovered(){const s=this.size/2;return e.mouseX>this.xpos-s&&e.mouseX<this.xpos+s&&e.mouseY>this.ypos-s&&e.mouseY<this.ypos+s}display(){const s=this.isHovered(),a=s?200:80;let r=e.color(255,255,255,a);e.fill(r);let l=e.color(255,255,255);e.stroke(l),e.rectMode(e.CENTER),e.rect(this.xpos,this.ypos,this.size,this.size,5);const d=s?150:50;r=e.color(0,0,0,d),e.fill(r),e.stroke(r),e.rect(this.xpos-this.size*.2,this.ypos+this.size*0,this.size*.25,this.size*.5),e.rect(this.xpos+this.size*.2,this.ypos+this.size*0,this.size*.25,this.size*.5)}}class i{constructor(s,a){this.x=s,this.y=a,this.diameter=1,this.lifespan=255}grow(){this.diameter=this.diameter+4,this.lifespan=this.lifespan-5}isDead(){return this.lifespan<=0}display(){e.fill(255,this.lifespan/1.5),e.stroke(255,this.lifespan/.1),e.ellipse(this.x,this.y,this.diameter,this.diameter)}}};class P{constructor(){c(this,"SAMPLE_LIBRARY",{"Grand Piano":[{note:"A",octave:4,file:"samples/Grand Piano/piano-f-a4.wav"},{note:"A",octave:5,file:"samples/Grand Piano/piano-f-a5.wav"},{note:"A",octave:6,file:"samples/Grand Piano/piano-f-a6.wav"},{note:"C",octave:4,file:"samples/Grand Piano/piano-f-c4.wav"},{note:"C",octave:5,file:"samples/Grand Piano/piano-f-c5.wav"},{note:"C",octave:6,file:"samples/Grand Piano/piano-f-c6.wav"},{note:"D#",octave:4,file:"samples/Grand Piano/piano-f-d#4.wav"},{note:"D#",octave:5,file:"samples/Grand Piano/piano-f-d#5.wav"},{note:"D#",octave:6,file:"samples/Grand Piano/piano-f-d#6.wav"},{note:"F#",octave:4,file:"samples/Grand Piano/piano-f-f#4.wav"},{note:"F#",octave:5,file:"samples/Grand Piano/piano-f-f#5.wav"},{note:"F#",octave:6,file:"samples/Grand Piano/piano-f-f#6.wav"}],"Chorus female":[{note:"A",octave:4,file:"samples/Chorus/chorus-female-a4-PB-loop.wav"},{note:"A#",octave:4,file:"samples/Chorus/chorus-female-a#4-PB-loop.wav"},{note:"A",octave:5,file:"samples/Chorus/chorus-female-a5-PB-loop.wav"},{note:"A#",octave:5,file:"samples/Chorus/chorus-female-a#5-PB-loop.wav"},{note:"B",octave:4,file:"samples/Chorus/chorus-female-b4-PB-loop.wav"},{note:"B",octave:5,file:"samples/Chorus/chorus-female-b5-PB-loop.wav"},{note:"C",octave:5,file:"samples/Chorus/chorus-female-c5-PB-loop.wav"},{note:"C#",octave:5,file:"samples/Chorus/chorus-female-c#5-PB-loop.wav"},{note:"C",octave:6,file:"samples/Chorus/chorus-female-c6-PB-loop.wav"},{note:"D",octave:5,file:"samples/Chorus/chorus-female-d5-PB-loop.wav"},{note:"D#",octave:5,file:"samples/Chorus/chorus-female-d#5-PB-loop.wav"},{note:"E",octave:5,file:"samples/Chorus/chorus-female-e5-PB-loop.wav"},{note:"F",octave:5,file:"samples/Chorus/chorus-female-f5-PB-loop.wav"},{note:"F#",octave:5,file:"samples/Chorus/chorus-female-f#5-PB-loop.wav"},{note:"G",octave:4,file:"samples/Chorus/chorus-female-g4-PB-loop.wav"},{note:"G",octave:5,file:"samples/Chorus/chorus-female-g5-PB-loop.wav"},{note:"G#",octave:4,file:"samples/Chorus/chorus-female-g#4-PB-loop.wav"},{note:"G#",octave:5,file:"samples/Chorus/chorus-female-g#5-PB-loop.wav"}],Tremulo:[{note:"A#",octave:3,file:"samples/Tremulo/3_Bb.wav"},{note:"G",octave:3,file:"samples/Tremulo/3_G.wav"},{note:"A#",octave:4,file:"samples/Tremulo/4_Bb.wav"},{note:"C#",octave:4,file:"samples/Tremulo/4_Db.wav"},{note:"G",octave:4,file:"samples/Tremulo/4_G.wav"},{note:"B",octave:5,file:"samples/Tremulo/5_B.wav"},{note:"C#",octave:5,file:"samples/Tremulo/5_Db.wav"},{note:"E",octave:5,file:"samples/Tremulo/5_E.wav"},{note:"G",octave:5,file:"samples/Tremulo/5_G.wav"}]});c(this,"CONVOLVER_LIBRARY",{AirportTerminal:"samples/AirportTerminal.wav",RoomMedium:"samples/RoomMedium.wav"});c(this,"OCTAVE",["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]);c(this,"_audioContext",null);c(this,"_sampleCache",{});c(this,"_convolverCache",{});c(this,"_instrument","Grand Piano");c(this,"_convolver",null);c(this,"_gain",.7);c(this,"_fade",.7);this._audioContext=new AudioContext}fetchSample(t){return fetch(escape(t)).then(n=>n.arrayBuffer()).then(n=>this._audioContext.decodeAudioData(n))}noteValue(t,n){return n*12+this.OCTAVE.indexOf(t)}getNoteDistance(t,n,i,o){return this.noteValue(t,n)-this.noteValue(i,o)}getNearestSample(t,n,i){return t.slice().sort((s,a)=>{let r=Math.abs(this.getNoteDistance(n,i,s.note,s.octave)),l=Math.abs(this.getNoteDistance(n,i,a.note,a.octave));return r-l})[0]}flatToSharp(t){switch(t){case"Bb":return"A#";case"Db":return"C#";case"Eb":return"D#";case"Gb":return"F#";case"Ab":return"G#";default:return t}}async getSample(t,n){let[,i,o]=/^(\w[b#]?)(\d)$/.exec(n);o=parseInt(o,10),i=this.flatToSharp(i);let s=this.SAMPLE_LIBRARY[t],a=this.getNearestSample(s,i,o),r=this.getNoteDistance(i,o,a.note,a.octave);if(this._sampleCache[a.file])return{audioBuffer:this._sampleCache[a.file],distance:r};{const l=await this.fetchSample(a.file);return this._sampleCache[a.file]=l,{audioBuffer:l,distance:r}}}async playSample(t,n=0){await this.playSampleWithInstrument(this._instrument,t,this._convolver,n)}async playSampleWithInstrument(t,n,i=null,o=0){const{audioBuffer:s,distance:a}=await this.getSample(t,n);let r=Math.pow(2,a/12),l=this._audioContext.createBufferSource();l.buffer=s,l.playbackRate.value=r;const d=this._audioContext.createGain();d.gain.value=this._gain,d.gain.linearRampToValueAtTime(0,this._audioContext.currentTime+this._fade),i?l.connect(d).connect(i):l.connect(d).connect(this._audioContext.destination);const _=o>0?this._audioContext.currentTime+o:null;l.start(_)}async loadConvolver(t){const n=await this.fetchSample(t);let i=this._audioContext.createConvolver();return i.buffer=n,i.connect(this._audioContext.destination),console.log("Convolver loaded"),i}async setConvolver(t){const n=this.CONVOLVER_LIBRARY[t];if(n){if(!this._convolverCache[n]){const i=await this.loadConvolver(n);this._convolverCache[n]=i}console.log("setConvolver()",t,n),this._convolver=this._convolverCache[n]}else console.log("Deactivated convolver",t),this._convolver=null}setInstrument(t){this.SAMPLE_LIBRARY[t]?this._instrument=t:console.warn("Selected instrument not found:",t)}setGain(t){this._gain=t}setFade(t){this._fade=Number(Number(t).toFixed(2))}suspend(){this._audioContext.suspend()}resume(){this._audioContext.resume()}}const m={musicforairports:{title:"Brian Eno - Ambient 1: Music for Airports, 2/1 (1978)",notes:["F4","Ab4","C5","Db5","Eb5","F5","Ab5"]},gesdur_pentatonic:{title:"Ges-Dur-Pentatonik (schwarze Tasten)",notes:["F#2","G#2","A#2","C#3","D#3"]},cdur_pentatonic:{title:"C-Dur-Pentatonik",notes:["C3","D3","E3","G3","A3"]},amoll_pentatonic:{title:"A-Moll-Pentatonik",notes:["A2","C3","D3","E3","G3"]}},g={random:{title:"Random note from the pool"},static_melody:{title:"Static melody"},changing_melody_10:{title:"Changing melody, 10% chance"},changing_melody_30:{title:"Changing melody, 30% chance"},changing_melody_60:{title:"Changing melody, 60% chance"}};class B{constructor(t){this.soundGenerator=t,this.setNotepool("musicforairports"),this.setMelodygenerator("random"),this.currentNoteIndex=0}setNotepool(t){return m[t]?(this.currentNotepool=m[t].notes,this.currentMelody=[...m[t].notes],!0):!1}setMelodygenerator(t){return g[t]?(this.currentMelodygenerator=t,!0):!1}increaseNoteIndex(){this.currentNoteIndex++,this.currentNoteIndex>=this.currentMelody.length&&(this.currentNoteIndex=0)}playNextNote(){var t;if(this.currentMelodygenerator==="random")t=this.currentMelody[Math.floor(Math.random()*this.currentMelody.length)];else{t=this.currentMelody[this.currentNoteIndex];let i=!1;if(this.currentMelodygenerator==="changing_melody_10"&&Math.random()<.1&&(i=!0),this.currentMelodygenerator==="changing_melody_30"&&Math.random()<.3&&(i=!0),this.currentMelodygenerator==="changing_melody_60"&&Math.random()<.3&&(i=!0),i){var n=this.currentNotepool[Math.floor(Math.random()*this.currentNotepool.length)];this.currentMelody[this.currentNoteIndex]=n,console.log("Melody change:",n,this.currentMelody)}this.increaseNoteIndex()}t&&this.soundGenerator.playSample(t)}}document.querySelector("#app").innerHTML=`
<div>
	<div id="header">
		<div class="header_segment">
			<div class="header_logo">Sounds of decay</div>
		</div>
		<div class="header_segment">
			<div class="header_label">Note pool:</div>
			<div class="header_control"><select id="sel_notepool"></select></div>
		</div>
		<div class="header_segment">
			<div class="header_label">Melody generator:</div>
			<div class="header_control"><select id="sel_melodygenerator"></select></div>
		</div>
		<div class="header_segment">
			<div class="header_label">Intrument:</div>
			<div class="header_control">
				<select id="sel_instrument">
					<option value="Grand Piano">Grand Piano</option>
					<option value="Chorus female">Chorus female</option>
					<option value="Tremulo">Tremulo</option>
				</select>
			</div>
		</div>
		<div class="header_segment">
			<div class="header_label">Effects/convolver:</div>
			<div class="header_control">
				<select id="sel_convolver">
					<option value="">- None -</option>
					<option value="RoomMedium">Medium room</option>
					<option value="AirportTerminal">Airport Terminal</option>
				</select>
			</div>
		</div>
		<div class="header_segment">
			<div class="header_label">Gain:</div>
			<div class="header_control"><input type="range" id="rng_gain" min="0" max="2" value="0.7" step="0.01"></div>
		</div>
		<div class="header_segment">
			<div class="header_label">Fade time:</div>
			<div class="header_control"><input type="range" id="rng_fade" min="0" max="2" value="0.7" step="0.1"></div>
		</div>
	</div>

	<div id="p5-container"></div>

	<div id="footer">
		<div>More informations: <a href="https://github.com/toblum/sounds-of-decay" target="_blank">https://github.com/toblum/sounds-of-decay</a></div>
	</div>
</div>`;const v=document.getElementById("p5-container"),y=new p5(x,v),h=new P,p=new B(h);let f=new WebSocket("wss://decayrelay.tobiasblum.de");f.onopen=function(){console.log("[open] Connection established"),console.log("Sending to server")};f.onclose=function(e){e.wasClean?console.log(`[close] Connection closed cleanly, code=${e.code} reason=${e.reason}`):console.log("[close] Connection died")};f.onerror=function(e){console.log(`[error] ${e.message}`)};(async()=>{let e=!1;const t=()=>{p.playNextNote()},n=()=>{e=!0};f.onmessage=function(a){e&&a.data==="Decay"&&t(),y.addDecayParticle()};const i=()=>{e=!1,y.pause()};for(const a in m){const r=m[a];var o=document.createElement("option");o.text=r.title,o.value=a,document.getElementById("sel_notepool").add(o)}document.getElementById("sel_notepool").addEventListener("change",a=>{console.log("Set notepool to:",a.target.value),p.setNotepool(a.target.value)});for(const a in g){const r=g[a];var s=document.createElement("option");s.text=r.title,s.value=a,document.getElementById("sel_melodygenerator").add(s)}document.getElementById("sel_melodygenerator").addEventListener("change",a=>{console.log("Set melody generator to:",a.target.value),p.setMelodygenerator(a.target.value)}),document.getElementById("sel_instrument").addEventListener("change",a=>{console.log("Set intrument to:",a.target.value),h.setInstrument(a.target.value)}),document.getElementById("sel_convolver").addEventListener("change",a=>{console.log("Set convolver to:",a.target.value),h.setConvolver(a.target.value)}),document.getElementById("rng_gain").addEventListener("input",a=>{console.log("Set gain to:",a.target.value),h.setGain(a.target.value)}),document.getElementById("rng_fade").addEventListener("input",a=>{console.log("Set fade to:",a.target.value),h.setFade(a.target.value)}),v.addEventListener("clickPlay",()=>{n()}),v.addEventListener("clickPause",()=>{i()}),v.addEventListener("clickCanvas",()=>{t()})})();
